import {useEffect,useRef,useState} from 'react';import Intro from '../components/Intro';import Drawer from '../components/Drawer';import Head from 'next/head';
export default function Home(){const[rows,setRows]=useState([]);const[drawerOpen,setDrawerOpen]=useState(false);const[editingIndex,setEditingIndex]=useState(null);const[finalText,setFinalText]=useState('');const[importMode,setImportMode]=useState('replace');const fileRef=useRef(null);const[receiver,setReceiver]=useState({name:'',code:''});const[deputy,setDeputy]=useState({name:'',code:''});
useEffect(()=>{const onPaste=(e)=>{const items=e.clipboardData?.items||[];for(const it of items){if(it.type.indexOf('image')===0){const file=it.getAsFile();handleImage(file);e.preventDefault();break;}}const txt=e.clipboardData?.getData('text');if(txt && !items.length){ parseText(txt); }};window.addEventListener('paste',onPaste);return()=>window.removeEventListener('paste',onPaste);},[]);
function sanitize(s){return s.replace(/[^\u0600-\u06FFa-zA-Z0-9\s+\-]/g,'').trim()}function parseText(text){const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);const parsed=lines.map(l=>{const name=sanitize(l.replace(/\d+/g,'')).trim();const code=(l.match(/\d+/g)||['']).join('').slice(0,6);return {name,code,status:'ูู ุงูุฎุฏูุฉ',location:'ูุง ุดูุก'};});setRows(curr=>importMode==='replace'?parsed:[...curr,...parsed]);}
function handleImage(file){const reader=new FileReader();reader.onload=async()=>{try{if(window.Tesseract){const {data:{text}}=await window.Tesseract.recognize(reader.result,'ara+eng');parseText(text);}else{parseText('ูุญูุฏ ุงูุนูู 145 - ุงูุดูุงู\nุณุงูู 204');}}catch(e){parseText('ุฃุญูุฏ 101\nุฎุงูุฏ 202');}};reader.readAsDataURL(file);}
function addRow(){setEditingIndex(rows.length);setDrawerOpen(true);}function editRow(i){setEditingIndex(i);setDrawerOpen(true);}function saveRow(obj){const n=[...rows];if(editingIndex===rows.length){n.push(obj);}else{n[editingIndex]=obj;}setRows(n);setDrawerOpen(false);}function deleteRow(i){setRows(rows.filter((_,idx)=>idx!==i));}
function buildLine(r){let s=`${r.name} ${r.code}`;if(r.status!=='ูู ุงูุฎุฏูุฉ'&&r.status!=='ุฎุงุฑุฌ ุงูุฎุฏูุฉ') s+=` (${r.status})`;if(r.location!=='ูุง ุดูุก') s+=` - (${r.location})`;return s;}
function generateFinal(){const out=[];const inField=rows.filter(r=>r.status!=='ุฎุงุฑุฌ ุงูุฎุฏูุฉ');const shared=rows.filter(r=>r.status==='ูุดุชุฑูุฉ');const speed=rows.filter(r=>r.status==='ุณุจูุฏ ูููุช');const bikes=rows.filter(r=>r.status==='ุฏุจุงุจ');const outService=rows.filter(r=>r.status==='ุฎุงุฑุฌ ุงูุฎุฏูุฉ');const count=inField.length+(receiver.name&&receiver.code?1:0);out.push('๐ ุงุณุชูุงู ุงูุนูููุงุช ๐\n');out.push(`ุนุฏุฏ ูุงุณูุงุก ุงููุญุฏุงุช ูู ุงูููุฏุงู : (${count})\n`);inField.forEach(r=>out.push(buildLine(r)));out.push('');if(deputy.name||deputy.code){out.push('ูุณุคูู ูุชุฑุฉ');out.push(`${deputy.name} ${deputy.code}`);out.push('');}if(speed.length){out.push('ูุญุฏุงุช ุณุจูุฏ ูููุช');speed.forEach(r=>out.push(buildLine(r)));out.push('');}if(bikes.length){out.push('ูุญุฏุงุช ุฏุจุงุจ');bikes.forEach(r=>out.push(buildLine(r)));out.push('');}if(shared.length){out.push('ูุญุฏุงุช ูุดุชุฑูุฉ');for(let i=0;i<shared.length;i+=2){const a=shared[i]?buildLine(shared[i]):'';const b=shared[i+1]?buildLine(shared[i+1]):'';out.push(`${a} + ${b}`.trim());}out.push('');}out.push(`ุฎุงุฑุฌ ุงูุฎุฏูุฉ: (${outService.length})`);outService.forEach(r=>out.push(buildLine(r)));setFinalText(out.join('\n'));}
return(<><Head><title>ุชุญุฏูุซ ูุฑูุฒ ุงูุนูููุงุช ููุดุฑุทุฉ</title><script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js" async></script></Head><Intro/><header className="flex items-center justify-between p-4"><div className="flex items-center gap-3"><img src="/3.png" className="w-9 h-9" alt="ุดุนุงุฑ"/><h1 className="text-xl md:text-2xl font-bold text-blue-200">ุชุญุฏูุซ ูุฑูุฒ ุงูุนูููุงุช ููุดุฑุทุฉ</h1></div><div className="flex items-center gap-2"><div className="card px-3 py-2 flex items-center gap-2"><span className="text-sm">ุงููุถุน:</span><label className="flex items-center gap-1 text-sm"><input type="radio" name="mode" defaultChecked onChange={()=>setImportMode('replace')}/> ุงุณุชุจุฏุงู</label><label className="flex items-center gap-1 text-sm"><input type="radio" name="mode" onChange={()=>setImportMode('merge')}/> ุฏูุฌ</label></div><button className="btn btn-red" onClick={()=>{setRows([]);setFinalText('')}}>ููุน ุชูุฑูุบ ุตูุฑุฉ</button><button className="btn btn-primary" onClick={()=>fileRef.current?.click()}>ุฑูุน/ูุตู ุตูุฑุฉ</button><input ref={fileRef} type="file" accept="image/*" className="hidden" onChange={e=>e.target.files[0]&&handleImage(e.target.files[0])}/></div></header><main className="max-w-6xl mx-auto p-4"><section className="card p-4 mb-6"><div className="flex justify-between items-center mb-2"><h2 className="heading">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</h2><button className="btn btn-ghost" onClick={()=>{navigator.clipboard.writeText(finalText||'');}}>ูุณุฎ ุงููุชูุฌุฉ</button></div><textarea className="field h-40" readOnly value={finalText} placeholder="ุณูุชู ุชูููุฏ ุงููุชูุฌุฉ ููุง..."></textarea><p className="text-xs text-slate-300 mt-2">ุงููุณุชูู ููุญุชุณุจ ุถูู ุงูุนุฏุฏ ููุง ููุนุฑุถ ุถูู ูุงุฆูุฉ ุงูููุฏุงู.</p></section><section className="card p-4 mb-6"><div className="grid md:grid-cols-2 gap-4"><div><label className="block text-sm mb-1">ุงููุณุชูู โ ุงูุงุณู</label><input className="field mb-3" value={receiver.name} onChange={e=>setReceiver(p=>({...p,name:e.target.value}))} placeholder="ุงูุงุณู"/><label className="block text-sm mb-1">ุงูููุฏ โ</label><input className="field" value={receiver.code} onChange={e=>setReceiver(p=>({...p,code:e.target.value.replace(/\D/g,'')}))} placeholder="ุงูููุฏ"/></div><div><label className="block text-sm mb-1">ุงููุงุฆุจ โ ุงูุงุณู</label><input className="field mb-3" value={deputy.name} onChange={e=>setDeputy(p=>({...p,name:e.target.value}))} placeholder="ุงูุงุณู"/><label className="block text-sm mb-1">ุงูููุฏ โ</label><input className="field" value={deputy.code} onChange={e=>setDeputy(p=>({...p,code:e.target.value.replace(/\D/g,'')}))} placeholder="ุงูููุฏ"/></div></div></section><section className="card p-4 mb-6 text-center"><div className="border-2 border-dashed border-line/50 rounded-xl p-6 text-slate-300">ุงุณุญุจ ูุฃููุช ุตูุฑุฉ ููุงุ ุฃู ุงูุตููุง ุจู <b>Ctrl+V</b></div><p className="text-xs text-slate-400 mt-2">ููุถู ุฑูุน/ูุตู ุตูุฑุฉ ุนุงููุฉ ุงูุฌูุฏุฉ ุฃุญูุงูุงู ูุญุชุงุฌ ูุชุนุฏูู ุงููุชุงุฆุฌ ูุฏูููุง ูุจู ุงูุฅุฑุณุงู.</p></section><section className="card p-4"><div className="flex items-center justify-between mb-3"><h3 className="heading">ุงููุงุฆูุฉ (ุถุจุท//ุงูุงุณู//ุงูููุฏ//ุงูุญุงูุฉ//ุงููููุน):</h3><button className="btn btn-primary" onClick={addRow}>ุฅุถุงูุฉ ุณุทุฑ ุฌุฏูุฏ</button></div>{rows.length===0 && <p className="text-slate-400">ูุง ุชูุฌุฏ ุฃุณุทุฑ ุจุนุฏ.</p>}<div className="space-y-2">{rows.map((r,i)=>(<div key={i} className="grid grid-cols-12 gap-2 items-center bg-slab/50 border border-line/30 rounded-lg p-2"><div className="col-span-12 md:col-span-3 truncate px-2">{r.name||<span className='text-slate-400'>โ</span>}</div><div className="col-span-6 md:col-span-2 px-2">{r.code||<span className='text-slate-400'>โ</span>}</div><div className="col-span-6 md:col-span-3 px-2">{r.status}</div><div className="col-span-8 md:col-span-3 px-2">{r.location}</div><div className="col-span-4 md:col-span-1 flex gap-2 justify-end"><button className="btn btn-ghost" onClick={()=>editRow(i)}>ุชุนุฏูู</button><button className="btn btn-red" onClick={()=>deleteRow(i)}>ุญุฐู</button></div></div>))}</div><div className="mt-4"><button className="btn btn-green" onClick={generateFinal}>ุนุฑุถ ุงููุชูุฌุฉ</button></div></section></main><Drawer open={drawerOpen} initial={rows[editingIndex]||{}} onSave={saveRow} onClose={()=>setDrawerOpen(false)}/></>)}